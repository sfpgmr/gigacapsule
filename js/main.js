'use strict';

var app = require('app');
var BrowserWindow = require('browser-window');
var ipc = require('ipc');
var fs = require('fs');
var path = require('path');
var ffmpeg = require('basicFFmpeg');
var cacheRoot = path.join(app.getPath('cache'), 'sfpgmr');
var cachePath = path.join(cacheRoot, 'gigacapsule');
var workPath = path.join(cachePath, 'work');
var gigaCapsule = '';
var mkdir = denodeify(fs.mkdir);
var access = denodeify(fs.access);
var exec = denodeify(require('child_process').exec);
var playPromises = Promise.resolve(0);
var cachePromises = Promise.resolve(0);

require('crash-reporter').start();

var mainWindow = null;

app.on('window-all-closed', function () {
  if (process.platform != 'darwin') app.quit();
});

function denodeify(nodeFunc) {
  var baseArgs = Array.prototype.slice.call(arguments, 1);
  return function () {
    var _arguments = arguments;

    var nodeArgs = baseArgs.concat(Array.prototype.slice.call(arguments));
    return new Promise(function (resolve, reject) {
      nodeArgs.push(function (error, data) {
        if (error) {
          reject(error);
        } else if (_arguments.length > 2) {
          resolve(Array.prototype.slice.call(_arguments, 1));
        } else {
          resolve(data);
        }
      });
      nodeFunc.apply(null, nodeArgs);
    });
  };
}

app.on('ready', function () {
  // Giga Capsule ディスクをチェックする
  // Windows のみ...
  exec('wmic logicaldisk get caption').then(function (stdout, stderr) {
    return new Promise(function (resolve, reject) {
      stdout.split(/\r\r\n/).forEach(function (d) {
        if (d.match(/\:/)) {
          var drive = d.trim();
          if (fs.existsSync(drive + '/YMOGIGA.EXE')) {
            resolve(drive);
          }
        }
      });
      reject('Giga Capsule Disk Not Found.');
    });
  }).then(function (drive) {
    // Giga Capsuleのドライブ判明
    gigaCapsule = path.join(drive, '/');
    console.log(gigaCapsule);
    // キャッシュディレクトリ作成
    return mkdir(cacheRoot);
  }).then(function () {
    return mkdir(cachePath);
  }, function (e) {
    if (e.code !== 'EEXIST') {
      return Promise.reject(e);
    } else {
      return mkdir(cachePath);
    }
  }).then(function () {
    return Promise.resolve();
  }, function (e) {
    if (e.code !== 'EEXIST') {
      Promise.reject(e);
    }
    return Promise.resolve();
  }).then(function () {
    return mkdir(workPath).then(function () {
      return Promise.resolve();
    }, function (e) {
      if (e.code !== 'EEXIST') {
        Promise.reject(e);
      }
      return Promise.resolve();
    });
  }).then(function () {
    return new Promise(function (resolve, reject) {
      // ブラウザ(Chromium)の起動, 初期画面のロード
      mainWindow = new BrowserWindow({
        'width': 1024,
        'height': 768,
        'use-content-size': true,
        'center': true,
        'auto-hide-menu-bar': true,
        'title': 'YMO Giga Capusle Viewer',
        'web-preferences': {
          'direct-write': true
        }
      });
      mainWindow.loadUrl('file://' + __dirname + '/../index.html');
      mainWindow.on('closed', function () {
        mainWindow = null;
      });
      mainWindow.webContents.on('did-finish-load', function () {
        resolve();
      });
    });
  })
  // コンテンツの再生
  .then(function () {
    playVideo('/MOVIE/QT/TITLE');
    playVideo('/MOVIE/QT/START_H');
    playAudio('/MOVIE/SOUND/OPENING');
    playAudio('/SAMPLING/03FIRECR/03_01');
    playAudio('/SAMPLING/03FIRECR/03_02');
    playAudio('/SAMPLING/03FIRECR/03_03');
    playAudio('/SAMPLING/03FIRECR/03_04');
    playAudio('/SAMPLING/03FIRECR/03_05');
    // playAudio('/MOVIE/L1/SOUNDS/4_1');
    // playAudio('/MOVIE/L1/SOUNDS/4_2');
    // playAudio('/MOVIE/L1/SOUNDS/4_3');
    // playAudio('/MOVIE/L1/SOUNDS/4_4');
    //playAudio('/MOVIE/L1/SOUNDS/4_5');
    // playAudio('/MOVIE/L1/SOUNDS/4_6');
    //playAudio('/MOVIE/L1/SOUNDS/4_7');
    //playAudio('/MOVIE/L1/SOUNDS/4_8');
    playAudio('/MOVIE/L1/SOUNDS/12_1');
    playAudio('/MOVIE/L1/SOUNDS/12_2');
    playAudio('/MOVIE/L1/SOUNDS/12_3');
    playAudio('/MOVIE/L1/SOUNDS/12_4');
    playAudio('/MOVIE/L1/SOUNDS/12_5');
    playAudio('/MOVIE/L1/SOUNDS/12_6');
    playAudio('/MOVIE/L1/SOUNDS/12_7');
    playAudio('/MOVIE/L1/SOUNDS/12_8');
    playAudio('/MOVIE/L1/SOUNDS/12_9');
    playAudio('/MOVIE/L1/SOUNDS/12_10');
    playAudio('/MOVIE/L1/SOUNDS/12_11');
    playAudio('/MOVIE/L1/SOUNDS/12_12');
    return playPromises;
  }).then(function () {
    console.log('play end.');
    playPromises = Promise.resolve(0);
    cachePromises = Promise.resolve(0);
  })['catch'](function (e) {
    var dialog = require('dialog');
    dialog.showErrorBox('Error', e);
    //    console.log(e);
  });
  //app.quit();
});

// 動画ファイルのキャッシュ生成
function makeMovCache(pathFlagment) {
  var pathSrc = path.join(gigaCapsule, pathFlagment + '.MOV');
  var pathDest = path.join(cachePath, pathFlagment.replace(/\//ig, '_') + '.mp4');
  return makeCache(pathSrc, pathDest);
}

// オーディオファイルのキャッシュ生成
function makeAudioCache(pathFlagment) {
  var pathSrc = path.join(gigaCapsule, pathFlagment + '.AIF');
  var pathDest = path.join(cachePath, pathFlagment.replace(/\//ig, '_') + '.opus');
  return makeCache(pathSrc, pathDest);
}

// ビデオの再生
function playVideo(path) {
  var cachePromise = makeMovCache(path);
  // Promiseのチェインを2つ（キャッシュチェイン、再生チェイン）作る
  // 再生中に後続のデータのキャッシュを作れるようにするため

  // キャッシュのチェイン
  // 先行のキャッシュ生成が終わったらキャッシュ生成をシーケンシャルに行う
  cachePromises = cachePromises.then(function () {
    return cachePromise;
  });
  // 再生のチェイン
  // 先行の再生完了 -> キャッシュの生成終了まち -> 再生をシーケンシャルに行う
  playPromises = playPromises.then(function () {
    return cachePromise;
  }).then(playVideo_);
}

// オーディオの再生
function playAudio(path) {
  var cachePromise = makeAudioCache(path);
  // Promiseのチェインを2つ（キャッシュチェイン、再生チェイン）作る
  // 再生中に後続のデータのキャッシュを作れるようにするため

  // キャッシュのチェイン
  // 先行のキャッシュ生成が終わったらキャッシュ生成をシーケンシャルに行う
  cachePromises = cachePromises.then(function () {
    return cachePromise;
  });
  // 再生のチェイン
  // 先行の再生完了 -> キャッシュの生成終了まち -> 再生をシーケンシャルに行う
  playPromises = playPromises.then(function () {
    return cachePromise;
  }).then(playAudio_);
}

// コンテンツを再生可能な形式に変換し、キャッシュする
function makeCache(src, dest, option) {
  option = option || '';
  return access(dest, fs.F_OK).then(function () {
    return Promise.resolve(dest);
  }, // resolve
  function () {
    // reject
    // 作業中のファイルはテンポラリに保存
    var tmpPath = path.join(workPath, path.basename(dest));
    console.log(src, tmpPath);
    // ffmpegでファイル変換
    return exec('ffmpeg.exe -y -loglevel fatal -i ' + src + ' ' + option + ' ' + tmpPath)
    // 変換からテンポラリから移動
    .then(exec.bind(null, 'cmd /c move /Y ' + tmpPath + ' ' + dest), function (e) {
      console.log(e);
    })
    // 変換後のファイル名を返す
    .then(function () {
      return Promise.resolve(dest);
    });
  });
}

// ビデオの再生
function playVideo_(path) {
  return new Promise(function (resolve, reject) {
    mainWindow.webContents.send('playVideo', path);
    ipc.on('playVideoEnd', function () {
      resolve();
      console.log(path);
    });
  });
}

// オーディオの再生
function playAudio_(path) {
  return new Promise(function (resolve, reject) {
    mainWindow.webContents.send('playAudio', path);
    ipc.on('playAudioEnd', function () {
      resolve();
      console.log(path);
    });
  });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUViLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6QixJQUFJLGFBQWEsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUM5QyxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDekIsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZCLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDcEMsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3pELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ25ELElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNDLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQztBQUNyQixJQUFJLEtBQUssR0FBRyxTQUFTLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2hDLElBQUksTUFBTSxHQUFHLFNBQVMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbEMsSUFBSSxJQUFJLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNwRCxJQUFJLFlBQVksR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRXZDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDOztBQUVsQyxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7O0FBRXRCLEdBQUcsQ0FBQyxFQUFFLENBQUMsbUJBQW1CLEVBQUUsWUFBVztBQUNyQyxNQUFJLE9BQU8sQ0FBQyxRQUFRLElBQUksUUFBUSxFQUM5QixHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7Q0FDZCxDQUFDLENBQUM7O0FBRUgsU0FBUyxTQUFTLENBQUMsUUFBUSxFQUFDO0FBQ3hCLE1BQUksUUFBUSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDeEQsU0FBTyxZQUFXOzs7QUFDZCxRQUFJLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQ3RFLFdBQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLO0FBQ3BDLGNBQVEsQ0FBQyxJQUFJLENBQUMsVUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFLO0FBQzNCLFlBQUksS0FBSyxFQUFFO0FBQ1AsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNqQixNQUFNLElBQUksV0FBVSxNQUFNLEdBQUcsQ0FBQyxFQUFFO0FBQzdCLGlCQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxhQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDckQsTUFBTTtBQUNILGlCQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakI7T0FDSixDQUFDLENBQUM7QUFDSCxjQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztLQUNsQyxDQUFDLENBQUM7R0FDTixDQUFBO0NBQ0o7O0FBR0QsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsWUFBVzs7O0FBR3pCLE1BQUksQ0FBQyw4QkFBOEIsQ0FBQyxDQUNuQyxJQUFJLENBQUMsVUFBQyxNQUFNLEVBQUMsTUFBTSxFQUFLO0FBQ3ZCLFdBQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUMsTUFBTSxFQUFLO0FBQ25DLFlBQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsQ0FBQyxFQUFHO0FBQ2xDLFlBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBQztBQUNmLGNBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNyQixjQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxHQUFHLGNBQWMsQ0FBQyxFQUFDO0FBQ3ZDLG1CQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7V0FDaEI7U0FDRjtPQUNGLENBQUMsQ0FBQztBQUNILFlBQU0sQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0tBQzFDLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FDRCxJQUFJLENBQUMsVUFBQyxLQUFLLEVBQUc7O0FBRWIsZUFBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ25DLFdBQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7O0FBRXpCLFdBQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0dBQ3pCLENBQUMsQ0FDRCxJQUFJLENBQUMsWUFBSTtBQUNSLFdBQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0dBQ3ZCLEVBQUMsVUFBQyxDQUFDLEVBQUc7QUFDTCxRQUFHLENBQUMsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFDO0FBQ3JCLGFBQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUMxQixNQUFNO0FBQ0wsYUFBTyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7S0FDekI7R0FDSixDQUFDLENBQ0QsSUFBSSxDQUFDO1dBQUssT0FBTyxDQUFDLE9BQU8sRUFBRTtHQUFBLEVBQzFCLFVBQUMsQ0FBQyxFQUFHO0FBQ0gsUUFBRyxDQUFDLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBQztBQUNyQixhQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ25CO0FBQ0QsV0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7R0FDMUIsQ0FDRixDQUNBLElBQUksQ0FBQyxZQUFJO0FBQ1IsV0FBTyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQ3JCLElBQUksQ0FBQzthQUFLLE9BQU8sQ0FBQyxPQUFPLEVBQUU7S0FBQSxFQUMxQixVQUFDLENBQUMsRUFBSTtBQUNKLFVBQUcsQ0FBQyxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUM7QUFDckIsZUFBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztPQUNuQjtBQUNELGFBQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0tBQzFCLENBQUMsQ0FBQztHQUNOLENBQUMsQ0FDRCxJQUFJLENBQUMsWUFBTTtBQUNWLFdBQU8sSUFBSSxPQUFPLENBQUMsVUFBUyxPQUFPLEVBQUMsTUFBTSxFQUFDOztBQUV6QyxnQkFBVSxHQUFHLElBQUksYUFBYSxDQUM1QjtBQUNFLGVBQU8sRUFBRSxJQUFJO0FBQ2IsZ0JBQVEsRUFBRSxHQUFHO0FBQ2IsMEJBQWtCLEVBQUMsSUFBSTtBQUN2QixnQkFBUSxFQUFDLElBQUk7QUFDYiw0QkFBb0IsRUFBRSxJQUFJO0FBQzFCLGVBQU8sRUFBQyx5QkFBeUI7QUFDakMseUJBQWlCLEVBQUM7QUFDaEIsd0JBQWMsRUFBRSxJQUFJO1NBQ3JCO09BQ0YsQ0FDRixDQUFDO0FBQ0YsZ0JBQVUsQ0FBQyxPQUFPLENBQUMsU0FBUyxHQUFHLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzdELGdCQUFVLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxZQUFXO0FBQ2pDLGtCQUFVLEdBQUcsSUFBSSxDQUFDO09BQ25CLENBQUMsQ0FBQztBQUNILGdCQUFVLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxZQUFXO0FBQ3RELGVBQU8sRUFBRSxDQUFDO09BQ1gsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0dBQ0osQ0FBQzs7R0FFRCxJQUFJLENBQUMsWUFBSTtBQUNSLGFBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzdCLGFBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQy9CLGFBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xDLGFBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ3RDLGFBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ3RDLGFBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ3RDLGFBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ3RDLGFBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDOzs7Ozs7Ozs7QUFTdEMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbkMsYUFBUyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDcEMsYUFBUyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDcEMsYUFBUyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDcEMsV0FBTyxZQUFZLENBQUM7R0FDckIsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFJO0FBQ1YsV0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN6QixnQkFBWSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEMsaUJBQWEsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0dBQ3BDLENBQUMsU0FDSSxDQUFDLFVBQUMsQ0FBQyxFQUFHO0FBQ1YsUUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLFVBQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFDLENBQUMsQ0FBQyxDQUFDOztHQUVoQyxDQUFDLENBQUM7O0NBRUosQ0FBQyxDQUFDOzs7QUFHSCxTQUFTLFlBQVksQ0FBQyxZQUFZLEVBQUM7QUFDakMsTUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxDQUFDO0FBQzNELE1BQUksUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO0FBQzlFLFNBQU8sU0FBUyxDQUFDLE9BQU8sRUFBQyxRQUFRLENBQUMsQ0FBQztDQUNwQzs7O0FBR0QsU0FBUyxjQUFjLENBQUMsWUFBWSxFQUFDO0FBQ25DLE1BQUksT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsQ0FBQztBQUMzRCxNQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQztBQUMvRSxTQUFPLFNBQVMsQ0FBQyxPQUFPLEVBQUMsUUFBUSxDQUFDLENBQUM7Q0FDcEM7OztBQUdELFNBQVMsU0FBUyxDQUFDLElBQUksRUFDdkI7QUFDRSxNQUFJLFlBQVksR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7OztBQU10QyxlQUFhLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQztXQUFNLFlBQVk7R0FBQSxDQUFDLENBQUM7OztBQUd2RCxjQUFZLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztXQUFNLFlBQVk7R0FBQSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0NBRXZFOzs7QUFHRCxTQUFTLFNBQVMsQ0FBQyxJQUFJLEVBQUM7QUFDdEIsTUFBSSxZQUFZLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDOzs7Ozs7QUFNeEMsZUFBYSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUM7V0FBSyxZQUFZO0dBQUEsQ0FBQyxDQUFDOzs7QUFHdEQsY0FBWSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUM7V0FBTSxZQUFZO0dBQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztDQUN2RTs7O0FBR0QsU0FBUyxTQUFTLENBQUMsR0FBRyxFQUFDLElBQUksRUFBQyxNQUFNLEVBQ2xDO0FBQ0ksUUFBTSxHQUFHLE1BQU0sSUFBSSxFQUFFLENBQUM7QUFDdEIsU0FBTyxNQUFNLENBQUMsSUFBSSxFQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FDMUIsSUFBSSxDQUFDO1dBQUssT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7R0FBQTtBQUM5QixjQUFJOzs7QUFFRixRQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDdEQsV0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUMsT0FBTyxDQUFDLENBQUM7O0FBRXpCLFdBQU8sSUFBSSxDQUFDLG1DQUFtQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsTUFBTSxHQUFHLEdBQUcsR0FBRyxPQUFPLENBQUM7O0tBRWxGLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBQyxpQkFBaUIsR0FBRyxPQUFPLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFDLFVBQUMsQ0FBQyxFQUFHO0FBQUMsYUFBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUFDLENBQUM7O0tBRXJGLElBQUksQ0FBQzthQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO0tBQUEsQ0FBQyxDQUFDO0dBQ3BDLENBQ0YsQ0FBQztDQUNMOzs7QUFHRCxTQUFTLFVBQVUsQ0FBQyxJQUFJLEVBQUM7QUFDdkIsU0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBQyxNQUFNLEVBQUc7QUFDbkMsY0FBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFDLElBQUksQ0FBQyxDQUFDO0FBQzlDLE9BQUcsQ0FBQyxFQUFFLENBQUMsY0FBYyxFQUFDLFlBQVU7QUFDOUIsYUFBTyxFQUFFLENBQUM7QUFDVixhQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ25CLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQztDQUNKOzs7QUFHRCxTQUFTLFVBQVUsQ0FBQyxJQUFJLEVBQUM7QUFDdkIsU0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBQyxNQUFNLEVBQUc7QUFDbkMsY0FBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFDLElBQUksQ0FBQyxDQUFDO0FBQzlDLE9BQUcsQ0FBQyxFQUFFLENBQUMsY0FBYyxFQUFDLFlBQVU7QUFDOUIsYUFBTyxFQUFFLENBQUM7QUFDVixhQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ25CLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQztDQUNKIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG52YXIgYXBwID0gcmVxdWlyZSgnYXBwJyk7XHJcbnZhciBCcm93c2VyV2luZG93ID0gcmVxdWlyZSgnYnJvd3Nlci13aW5kb3cnKTtcclxudmFyIGlwYyA9IHJlcXVpcmUoJ2lwYycpO1xyXG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xyXG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxudmFyIGZmbXBlZyA9IHJlcXVpcmUoJ2Jhc2ljRkZtcGVnJyk7XHJcbnZhciBjYWNoZVJvb3QgPSBwYXRoLmpvaW4oYXBwLmdldFBhdGgoJ2NhY2hlJyksJ3NmcGdtcicpO1xyXG52YXIgY2FjaGVQYXRoID0gcGF0aC5qb2luKGNhY2hlUm9vdCwnZ2lnYWNhcHN1bGUnKTtcclxudmFyIHdvcmtQYXRoID0gcGF0aC5qb2luKGNhY2hlUGF0aCwnd29yaycpO1xyXG52YXIgZ2lnYUNhcHN1bGUgPSAnJztcclxudmFyIG1rZGlyID0gZGVub2RlaWZ5KGZzLm1rZGlyKTtcclxudmFyIGFjY2VzcyA9IGRlbm9kZWlmeShmcy5hY2Nlc3MpO1xyXG52YXIgZXhlYyA9IGRlbm9kZWlmeShyZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZXhlYyk7XHJcbnZhciBwbGF5UHJvbWlzZXMgPSBQcm9taXNlLnJlc29sdmUoMCk7XHJcbnZhciBjYWNoZVByb21pc2VzID0gUHJvbWlzZS5yZXNvbHZlKDApO1xyXG5cclxucmVxdWlyZSgnY3Jhc2gtcmVwb3J0ZXInKS5zdGFydCgpO1xyXG5cclxudmFyIG1haW5XaW5kb3cgPSBudWxsO1xyXG5cclxuYXBwLm9uKCd3aW5kb3ctYWxsLWNsb3NlZCcsIGZ1bmN0aW9uKCkge1xyXG4gIGlmIChwcm9jZXNzLnBsYXRmb3JtICE9ICdkYXJ3aW4nKVxyXG4gICAgYXBwLnF1aXQoKTtcclxufSk7XHJcblxyXG5mdW5jdGlvbiBkZW5vZGVpZnkobm9kZUZ1bmMpe1xyXG4gICAgdmFyIGJhc2VBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTtcclxuICAgIHJldHVybiBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgbm9kZUFyZ3MgPSBiYXNlQXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgbm9kZUFyZ3MucHVzaCgoZXJyb3IsIGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIG5vZGVGdW5jLmFwcGx5KG51bGwsIG5vZGVBcmdzKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuXHJcbmFwcC5vbigncmVhZHknLCBmdW5jdGlvbigpIHtcclxuICAvLyBHaWdhIENhcHN1bGUg44OH44Kj44K544Kv44KS44OB44Kn44OD44Kv44GZ44KLXHJcbiAgLy8gV2luZG93cyDjga7jgb8uLi5cclxuICBleGVjKCd3bWljIGxvZ2ljYWxkaXNrIGdldCBjYXB0aW9uJylcclxuICAudGhlbigoc3Rkb3V0LHN0ZGVycikgPT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLHJlamVjdCkgPT4ge1xyXG4gICAgICAgIHN0ZG91dC5zcGxpdCgvXFxyXFxyXFxuLykuZm9yRWFjaCgoZCk9PntcclxuICAgICAgICAgIGlmKGQubWF0Y2goL1xcOi8pKXtcclxuICAgICAgICAgICAgbGV0IGRyaXZlID0gZC50cmltKCk7XHJcbiAgICAgICAgICAgIGlmKGZzLmV4aXN0c1N5bmMoZHJpdmUgKyAnL1lNT0dJR0EuRVhFJykpe1xyXG4gICAgICAgICAgICAgIHJlc29sdmUoZHJpdmUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmVqZWN0KCdHaWdhIENhcHN1bGUgRGlzayBOb3QgRm91bmQuJyk7XHJcbiAgICB9KTtcclxuICB9KVxyXG4gIC50aGVuKChkcml2ZSk9PntcclxuICAgIC8vIEdpZ2EgQ2Fwc3VsZeOBruODieODqeOCpOODluWIpOaYjlxyXG4gICAgZ2lnYUNhcHN1bGUgPSBwYXRoLmpvaW4oZHJpdmUsJy8nKTtcclxuICAgIGNvbnNvbGUubG9nKGdpZ2FDYXBzdWxlKTtcclxuICAgIC8vIOOCreODo+ODg+OCt+ODpeODh+OCo+ODrOOCr+ODiOODquS9nOaIkFxyXG4gICAgcmV0dXJuIG1rZGlyKGNhY2hlUm9vdCk7XHJcbiAgfSlcclxuICAudGhlbigoKT0+e1xyXG4gICAgcmV0dXJuIG1rZGlyKGNhY2hlUGF0aCk7XHJcbiAgICB9LChlKT0+e1xyXG4gICAgICBpZihlLmNvZGUgIT09ICdFRVhJU1QnKXtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIG1rZGlyKGNhY2hlUGF0aCk7XHJcbiAgICAgIH1cclxuICB9KVxyXG4gIC50aGVuKCgpPT4gUHJvbWlzZS5yZXNvbHZlKCksXHJcbiAgICAoZSk9PntcclxuICAgICAgaWYoZS5jb2RlICE9PSAnRUVYSVNUJyl7XHJcbiAgICAgICAgUHJvbWlzZS5yZWplY3QoZSk7XHJcbiAgICAgIH0gXHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICAgIH1cclxuICApXHJcbiAgLnRoZW4oKCk9PntcclxuICAgIHJldHVybiBta2Rpcih3b3JrUGF0aClcclxuICAgIC50aGVuKCgpPT4gUHJvbWlzZS5yZXNvbHZlKCksXHJcbiAgICAgIChlKSA9PntcclxuICAgICAgICBpZihlLmNvZGUgIT09ICdFRVhJU1QnKXtcclxuICAgICAgICAgIFByb21pc2UucmVqZWN0KGUpO1xyXG4gICAgICAgIH0gXHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgICB9KTtcclxuICB9KVxyXG4gIC50aGVuKCgpID0+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLHJlamVjdCl7XHJcbiAgICAvLyDjg5bjg6njgqbjgrYoQ2hyb21pdW0p44Gu6LW35YuVLCDliJ3mnJ/nlLvpnaLjga7jg63jg7zjg4lcclxuICAgICAgbWFpbldpbmRvdyA9IG5ldyBCcm93c2VyV2luZG93KFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICd3aWR0aCc6IDEwMjQsXHJcbiAgICAgICAgICAnaGVpZ2h0JzogNzY4LFxyXG4gICAgICAgICAgJ3VzZS1jb250ZW50LXNpemUnOnRydWUsXHJcbiAgICAgICAgICAnY2VudGVyJzp0cnVlLFxyXG4gICAgICAgICAgJ2F1dG8taGlkZS1tZW51LWJhcic6IHRydWUsXHJcbiAgICAgICAgICAndGl0bGUnOidZTU8gR2lnYSBDYXB1c2xlIFZpZXdlcicsXHJcbiAgICAgICAgICAnd2ViLXByZWZlcmVuY2VzJzp7XHJcbiAgICAgICAgICAgICdkaXJlY3Qtd3JpdGUnOiB0cnVlXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgICBtYWluV2luZG93LmxvYWRVcmwoJ2ZpbGU6Ly8nICsgX19kaXJuYW1lICsgJy8uLi9pbmRleC5odG1sJyk7XHJcbiAgICAgIG1haW5XaW5kb3cub24oJ2Nsb3NlZCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIG1haW5XaW5kb3cgPSBudWxsO1xyXG4gICAgICB9KTtcclxuICAgICAgbWFpbldpbmRvdy53ZWJDb250ZW50cy5vbignZGlkLWZpbmlzaC1sb2FkJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICB9KTsgICAgXHJcbiAgICB9KTtcclxuICB9KVxyXG4gIC8vIOOCs+ODs+ODhuODs+ODhOOBruWGjeeUn1xyXG4gIC50aGVuKCgpPT57XHJcbiAgICBwbGF5VmlkZW8oJy9NT1ZJRS9RVC9USVRMRScpO1xyXG4gICAgcGxheVZpZGVvKCcvTU9WSUUvUVQvU1RBUlRfSCcpOyBcclxuICAgIHBsYXlBdWRpbygnL01PVklFL1NPVU5EL09QRU5JTkcnKTtcclxuICAgIHBsYXlBdWRpbygnL1NBTVBMSU5HLzAzRklSRUNSLzAzXzAxJyk7XHJcbiAgICBwbGF5QXVkaW8oJy9TQU1QTElORy8wM0ZJUkVDUi8wM18wMicpO1xyXG4gICAgcGxheUF1ZGlvKCcvU0FNUExJTkcvMDNGSVJFQ1IvMDNfMDMnKTtcclxuICAgIHBsYXlBdWRpbygnL1NBTVBMSU5HLzAzRklSRUNSLzAzXzA0Jyk7XHJcbiAgICBwbGF5QXVkaW8oJy9TQU1QTElORy8wM0ZJUkVDUi8wM18wNScpO1xyXG4gICAgLy8gcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzRfMScpO1xyXG4gICAgLy8gcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzRfMicpO1xyXG4gICAgLy8gcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzRfMycpO1xyXG4gICAgLy8gcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzRfNCcpO1xyXG4gICAgLy9wbGF5QXVkaW8oJy9NT1ZJRS9MMS9TT1VORFMvNF81Jyk7XHJcbiAgICAvLyBwbGF5QXVkaW8oJy9NT1ZJRS9MMS9TT1VORFMvNF82Jyk7XHJcbiAgICAvL3BsYXlBdWRpbygnL01PVklFL0wxL1NPVU5EUy80XzcnKTtcclxuICAgIC8vcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzRfOCcpO1xyXG4gICAgcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzEyXzEnKTtcclxuICAgIHBsYXlBdWRpbygnL01PVklFL0wxL1NPVU5EUy8xMl8yJyk7XHJcbiAgICBwbGF5QXVkaW8oJy9NT1ZJRS9MMS9TT1VORFMvMTJfMycpO1xyXG4gICAgcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzEyXzQnKTtcclxuICAgIHBsYXlBdWRpbygnL01PVklFL0wxL1NPVU5EUy8xMl81Jyk7XHJcbiAgICBwbGF5QXVkaW8oJy9NT1ZJRS9MMS9TT1VORFMvMTJfNicpO1xyXG4gICAgcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzEyXzcnKTtcclxuICAgIHBsYXlBdWRpbygnL01PVklFL0wxL1NPVU5EUy8xMl84Jyk7XHJcbiAgICBwbGF5QXVkaW8oJy9NT1ZJRS9MMS9TT1VORFMvMTJfOScpO1xyXG4gICAgcGxheUF1ZGlvKCcvTU9WSUUvTDEvU09VTkRTLzEyXzEwJyk7XHJcbiAgICBwbGF5QXVkaW8oJy9NT1ZJRS9MMS9TT1VORFMvMTJfMTEnKTtcclxuICAgIHBsYXlBdWRpbygnL01PVklFL0wxL1NPVU5EUy8xMl8xMicpO1xyXG4gICAgcmV0dXJuIHBsYXlQcm9taXNlcztcclxuICB9KS50aGVuKCgpPT57XHJcbiAgICBjb25zb2xlLmxvZygncGxheSBlbmQuJyk7XHJcbiAgICBwbGF5UHJvbWlzZXMgPSBQcm9taXNlLnJlc29sdmUoMCk7XHJcbiAgICBjYWNoZVByb21pc2VzID0gUHJvbWlzZS5yZXNvbHZlKDApO1xyXG4gIH0pXHJcbiAgLmNhdGNoKChlKT0+e1xyXG4gICAgdmFyIGRpYWxvZyA9IHJlcXVpcmUoJ2RpYWxvZycpO1xyXG4gICAgZGlhbG9nLnNob3dFcnJvckJveCgnRXJyb3InLGUpO1xyXG4vLyAgICBjb25zb2xlLmxvZyhlKTtcclxuICB9KTtcclxuICAvL2FwcC5xdWl0KCk7XHJcbn0pO1xyXG5cclxuLy8g5YuV55S744OV44Kh44Kk44Or44Gu44Kt44Oj44OD44K344Ol55Sf5oiQXHJcbmZ1bmN0aW9uIG1ha2VNb3ZDYWNoZShwYXRoRmxhZ21lbnQpe1xyXG4gIHZhciBwYXRoU3JjID0gcGF0aC5qb2luKGdpZ2FDYXBzdWxlLHBhdGhGbGFnbWVudCArICcuTU9WJyk7XHJcbiAgdmFyIHBhdGhEZXN0ID0gcGF0aC5qb2luKGNhY2hlUGF0aCxwYXRoRmxhZ21lbnQucmVwbGFjZSgvXFwvL2lnLCdfJykgKyAnLm1wNCcpO1xyXG4gIHJldHVybiBtYWtlQ2FjaGUocGF0aFNyYyxwYXRoRGVzdCk7XHJcbn1cclxuXHJcbi8vIOOCquODvOODh+OCo+OCquODleOCoeOCpOODq+OBruOCreODo+ODg+OCt+ODpeeUn+aIkFxyXG5mdW5jdGlvbiBtYWtlQXVkaW9DYWNoZShwYXRoRmxhZ21lbnQpe1xyXG4gIHZhciBwYXRoU3JjID0gcGF0aC5qb2luKGdpZ2FDYXBzdWxlLHBhdGhGbGFnbWVudCArICcuQUlGJyk7XHJcbiAgdmFyIHBhdGhEZXN0ID0gcGF0aC5qb2luKGNhY2hlUGF0aCxwYXRoRmxhZ21lbnQucmVwbGFjZSgvXFwvL2lnLCdfJykgKyAnLm9wdXMnKTtcclxuICByZXR1cm4gbWFrZUNhY2hlKHBhdGhTcmMscGF0aERlc3QpO1xyXG59XHJcblxyXG4vLyDjg5Pjg4fjgqrjga7lho3nlJ9cclxuZnVuY3Rpb24gcGxheVZpZGVvKHBhdGgpXHJcbntcclxuICB2YXIgY2FjaGVQcm9taXNlID0gbWFrZU1vdkNhY2hlKHBhdGgpO1xyXG4gIC8vIFByb21pc2Xjga7jg4HjgqfjgqTjg7PjgpIy44Gk77yI44Kt44Oj44OD44K344Ol44OB44Kn44Kk44Oz44CB5YaN55Sf44OB44Kn44Kk44Oz77yJ5L2c44KLXHJcbiAgLy8g5YaN55Sf5Lit44Gr5b6M57aa44Gu44OH44O844K/44Gu44Kt44Oj44OD44K344Ol44KS5L2c44KM44KL44KI44GG44Gr44GZ44KL44Gf44KBXHJcblxyXG4gIC8vIOOCreODo+ODg+OCt+ODpeOBruODgeOCp+OCpOODs1xyXG4gIC8vIOWFiOihjOOBruOCreODo+ODg+OCt+ODpeeUn+aIkOOBjOe1guOCj+OBo+OBn+OCieOCreODo+ODg+OCt+ODpeeUn+aIkOOCkuOCt+ODvOOCseODs+OCt+ODo+ODq+OBq+ihjOOBhlxyXG4gIGNhY2hlUHJvbWlzZXMgPSBjYWNoZVByb21pc2VzLnRoZW4oKCkgPT4gY2FjaGVQcm9taXNlKTtcclxuICAvLyDlho3nlJ/jga7jg4HjgqfjgqTjg7NcclxuICAvLyDlhYjooYzjga7lho3nlJ/lrozkuoYgLT4g44Kt44Oj44OD44K344Ol44Gu55Sf5oiQ57WC5LqG44G+44GhIC0+IOWGjeeUn+OCkuOCt+ODvOOCseODs+OCt+ODo+ODq+OBq+ihjOOBhlxyXG4gIHBsYXlQcm9taXNlcyA9IHBsYXlQcm9taXNlcy50aGVuKCgpID0+IGNhY2hlUHJvbWlzZSkudGhlbihwbGF5VmlkZW9fKTtcclxuXHJcbn1cclxuXHJcbi8vIOOCquODvOODh+OCo+OCquOBruWGjeeUn1xyXG5mdW5jdGlvbiBwbGF5QXVkaW8ocGF0aCl7XHJcbiAgdmFyIGNhY2hlUHJvbWlzZSA9IG1ha2VBdWRpb0NhY2hlKHBhdGgpO1xyXG4gIC8vIFByb21pc2Xjga7jg4HjgqfjgqTjg7PjgpIy44Gk77yI44Kt44Oj44OD44K344Ol44OB44Kn44Kk44Oz44CB5YaN55Sf44OB44Kn44Kk44Oz77yJ5L2c44KLXHJcbiAgLy8g5YaN55Sf5Lit44Gr5b6M57aa44Gu44OH44O844K/44Gu44Kt44Oj44OD44K344Ol44KS5L2c44KM44KL44KI44GG44Gr44GZ44KL44Gf44KBXHJcblxyXG4gIC8vIOOCreODo+ODg+OCt+ODpeOBruODgeOCp+OCpOODs1xyXG4gIC8vIOWFiOihjOOBruOCreODo+ODg+OCt+ODpeeUn+aIkOOBjOe1guOCj+OBo+OBn+OCieOCreODo+ODg+OCt+ODpeeUn+aIkOOCkuOCt+ODvOOCseODs+OCt+ODo+ODq+OBq+ihjOOBhlxyXG4gIGNhY2hlUHJvbWlzZXMgPSBjYWNoZVByb21pc2VzLnRoZW4oKCk9PiBjYWNoZVByb21pc2UpO1xyXG4gIC8vIOWGjeeUn+OBruODgeOCp+OCpOODs1xyXG4gIC8vIOWFiOihjOOBruWGjeeUn+WujOS6hiAtPiDjgq3jg6Pjg4Pjgrfjg6Xjga7nlJ/miJDntYLkuobjgb7jgaEgLT4g5YaN55Sf44KS44K344O844Kx44Oz44K344Oj44Or44Gr6KGM44GGXHJcbiAgcGxheVByb21pc2VzID0gcGxheVByb21pc2VzLnRoZW4oKCkgPT4gY2FjaGVQcm9taXNlKS50aGVuKHBsYXlBdWRpb18pO1xyXG59XHJcblxyXG4vLyDjgrPjg7Pjg4bjg7Pjg4TjgpLlho3nlJ/lj6/og73jgarlvaLlvI/jgavlpInmj5vjgZfjgIHjgq3jg6Pjg4Pjgrfjg6XjgZnjgotcclxuZnVuY3Rpb24gbWFrZUNhY2hlKHNyYyxkZXN0LG9wdGlvbilcclxue1xyXG4gICAgb3B0aW9uID0gb3B0aW9uIHx8ICcnO1xyXG4gICAgcmV0dXJuIGFjY2VzcyhkZXN0LGZzLkZfT0spXHJcbiAgICAudGhlbigoKT0+IFByb21pc2UucmVzb2x2ZShkZXN0KSwvLyByZXNvbHZlXHJcbiAgICAgICgpPT57Ly8gcmVqZWN0XHJcbiAgICAgICAgLy8g5L2c5qWt5Lit44Gu44OV44Kh44Kk44Or44Gv44OG44Oz44Od44Op44Oq44Gr5L+d5a2YXHJcbiAgICAgICAgdmFyIHRtcFBhdGggPSBwYXRoLmpvaW4od29ya1BhdGgscGF0aC5iYXNlbmFtZShkZXN0KSk7XHJcbiAgICAgICAgY29uc29sZS5sb2coc3JjLHRtcFBhdGgpO1xyXG4gICAgICAgIC8vIGZmbXBlZ+OBp+ODleOCoeOCpOODq+WkieaPm1xyXG4gICAgICAgIHJldHVybiBleGVjKCdmZm1wZWcuZXhlIC15IC1sb2dsZXZlbCBmYXRhbCAtaSAnICsgc3JjICsgJyAnICsgb3B0aW9uICsgJyAnICsgdG1wUGF0aClcclxuICAgICAgICAgIC8vIOWkieaPm+OBi+OCieODhuODs+ODneODqeODquOBi+OCieenu+WLlVxyXG4gICAgICAgICAgLnRoZW4oZXhlYy5iaW5kKG51bGwsJ2NtZCAvYyBtb3ZlIC9ZICcgKyB0bXBQYXRoICsgJyAnICsgZGVzdCksKGUpPT57Y29uc29sZS5sb2coZSk7fSlcclxuICAgICAgICAgIC8vIOWkieaPm+W+jOOBruODleOCoeOCpOODq+WQjeOCkui/lOOBmVxyXG4gICAgICAgICAgLnRoZW4oKCk9PlByb21pc2UucmVzb2x2ZShkZXN0KSk7XHJcbiAgICAgIH1cclxuICAgICk7XHJcbn1cclxuXHJcbi8vIOODk+ODh+OCquOBruWGjeeUn1xyXG5mdW5jdGlvbiBwbGF5VmlkZW9fKHBhdGgpe1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSxyZWplY3QpPT57XHJcbiAgICBtYWluV2luZG93LndlYkNvbnRlbnRzLnNlbmQoJ3BsYXlWaWRlbycscGF0aCk7XHJcbiAgICBpcGMub24oJ3BsYXlWaWRlb0VuZCcsZnVuY3Rpb24oKXtcclxuICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICBjb25zb2xlLmxvZyhwYXRoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59XHJcblxyXG4vLyDjgqrjg7zjg4fjgqPjgqrjga7lho3nlJ9cclxuZnVuY3Rpb24gcGxheUF1ZGlvXyhwYXRoKXtcclxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUscmVqZWN0KT0+e1xyXG4gICAgbWFpbldpbmRvdy53ZWJDb250ZW50cy5zZW5kKCdwbGF5QXVkaW8nLHBhdGgpO1xyXG4gICAgaXBjLm9uKCdwbGF5QXVkaW9FbmQnLGZ1bmN0aW9uKCl7XHJcbiAgICAgIHJlc29sdmUoKTtcclxuICAgICAgY29uc29sZS5sb2cocGF0aCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufVxyXG5cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
